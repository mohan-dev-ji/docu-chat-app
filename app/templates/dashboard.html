{% extends "base.html" %}

{% block content %}
    <h1>Dashboard</h1>
    <p>Welcome, {{ current_user.username }}!</p>
    
    <div class="dashboard-container">
        <div class="column files-column">
            <h2>Files</h2>
            <h3>Upload a new PDF</h3>
            <form method="post" enctype="multipart/form-data">
                <input type="file" name="pdf_file" accept=".pdf">
                <input type="submit" value="Upload">
            </form>
            
            <h3>Your PDFs</h3>
            {% if pdfs %}
                <ul>
                {% for pdf in pdfs %}
                    <li>
                        <a href="#" class="pdf-link" data-pdf-id="{{ pdf.id }}">{{ pdf.filename }}</a>
                        (Uploaded on: {{ pdf.upload_date }})
                        <form action="{{ url_for('main.delete_pdf', pdf_id=pdf.id) }}" method="post" style="display: inline;">
                            <input type="submit" value="Delete" onclick="return confirm('Are you sure you want to delete this PDF?');">
                        </form>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>You haven't uploaded any PDFs yet.</p>
            {% endif %}
        </div>
        
        <div class="column preview-column">
            <h2>Preview</h2>
            <!-- Placeholder for PDF preview -->
            <div id="pdf-viewer"></div>
        </div>
        
        <div class="column chat-column">
            <h2>Chat</h2>
            <!-- Placeholder for chat functionality -->
            <p>Chat functionality will be implemented here.</p>
        </div>
    </div>
    

    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <ul class="flashes">
        {% for message in messages %}
            <li>{{ message }}</li>
        {% endfor %}
        </ul>
    {% endif %}
    {% endwith %}
{% endblock %}

{% block styles %}
<style>
    .dashboard-container {
        display: flex;
        justify-content: space-between;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        height: 80vh;
    }
    .column {
        flex: 1;
        border: 1px solid #ccc;
        padding: 20px;
        margin: 0 10px;
        border-radius: 8px;
        background-color: #f9f9f9;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    #pdf-viewer {
        flex-grow: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #pdf-viewer canvas {
        max-width: 100%;
        height: auto !important;
        margin-bottom: 10px;
    }
    .files-column {
        flex-basis: 20%;
    }
    .preview-column {
        flex-basis: 40%;
    }
    .chat-column {
        flex-basis: 40%;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const pdfLinks = document.querySelectorAll('.pdf-link');
        const pdfViewer = document.getElementById('pdf-viewer');

        pdfLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const pdfId = this.getAttribute('data-pdf-id');
                console.log('PDF clicked:', pdfId);
                loadPDF(pdfId);
            });
        });

        function loadPDF(pdfId) {
            const url = `/pdf/${pdfId}`;
            console.log('Loading PDF from URL:', url);
            
            // Load the PDF document
            pdfjsLib.getDocument(url).promise.then(function(pdf) {
                console.log('PDF loaded successfully');
                // Clear the viewer
                pdfViewer.innerHTML = '';

                // Render each page
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    pdf.getPage(pageNum).then(function(page) {
                        const scale = 1.5;
                        const viewport = page.getViewport({ scale: scale });

                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };

                        page.render(renderContext);
                        pdfViewer.appendChild(canvas);
                    });
                }
            }).catch(function(error) {
                console.error('Error loading PDF:', error);
            });
        }
    });
</script>
{% endblock %}